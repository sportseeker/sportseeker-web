wp.media.view.EnviraGalleryError=wp.Backbone.View.extend({tagName:"div",className:"notice error envira-gallery-error",render:function(){return this.template=wp.media.template("envira-gallery-error"),this.$el.html(this.template(this.model)),this}}),wp.media.view.EnviraGalleryItem=wp.Backbone.View.extend({tagName:"li",className:"attachment envira-gallery-item",render:function(){return this.template=wp.media.template("envira-gallery-item"),this.$el.html(this.template(this.model.toJSON())),this}}),wp.media.view.Toolbar.EnviraGalleryToolbar=wp.media.view.Toolbar.extend({initialize:function(){_.defaults(this.options,{event:"envira_gallery_insert",close:!1,items:{envira_gallery_insert:{id:"envira-gallery-insert-button",style:"primary",text:wp.media.view.l10n.insertIntoPost,priority:80,requires:!1,click:function(){this.controller.state().insert()}}}}),wp.media.view.Toolbar.prototype.initialize.apply(this,arguments)},refresh:function(){var e=this.controller.state().props;this.get("envira_gallery_insert").model.set("disabled",!e.length),wp.media.view.Toolbar.prototype.refresh.apply(this,arguments)}}),wp.media.view.EnviraGalleryView=wp.media.View.extend({className:"attachments-browser envira-gallery",path:"/",is_loading:!1,events:{"click .envira-gallery-item":"click",keyup:"search",search:"search"},get_action:"",search_action:"",initialize:function(e){this.collection=new Backbone.Collection,this.$el.prepend(wp.media.template("envira-gallery-search-bar")),this.$el.prepend(wp.media.template(e.sidebar_template)),this.$el.prepend(wp.media.template("envira-gallery-items")),this.on("loading",this.loading,this),this.on("loaded",this.loaded,this),this.get_action=e.get_action,this.search_action=e.search_action,this.path=e.path,this.getItems(!1,"")},click:function(e){var t=jQuery(e.currentTarget),i=jQuery("div.attachment-preview",t).attr("data-is-dir"),a=jQuery("div.attachment-preview",t).attr("data-id");"true"==i?(this.path=a,this.getItems(!1,"")):t.hasClass("selected")?this.removeFromSelection(t,a):this.addToSelection(t,a)},search:function(e){if(!this.is_loading){var t=e.target.value;return 0==t.length?void this.getItems(!1,""):void(t.length<3||this.getItems(!0,t))}},loading:function(){this.is_loading=!0,this.$el.find(".spinner").addClass("is-active")},loaded:function(e){this.is_loading=!1,this.$el.find(".spinner").removeClass("is-active"),this.$el.find("div.envira-gallery-error").remove(),"undefined"!=typeof e&&this.$el.find("div.media-toolbar").after(this.renderError(e)),this.controller.toolbar.get().refresh()},clearItems:function(){this.$el.find("ul.envira-gallery-attachments li.attachment.selected").removeClass("selected details"),this.$el.find("ul.envira-gallery-attachments").empty()},getItems:function(e,t){if(!this.is_loading){this.trigger("loading"),this.clearItems();var i=e?this.search_action:this.get_action,a={nonce:envira_gallery_media_insert.nonce,path:this.path};e&&(a.search=t),wp.media.ajax(i,{context:this,data:a,success:function(e){var t=new Backbone.Collection(e);this.collection.reset(),this.collection.add(t.models),this.collection.each(function(e){this.$el.find("ul.envira-gallery-attachments").append(this.renderItem(e))},this),this.trigger("loaded")},error:function(e){this.trigger("loaded",e)}})}},renderItem:function(e){var t=new wp.media.view.EnviraGalleryItem({model:e});return t.render().el},renderError:function(e){var t={};t.error=e;var i=new wp.media.view.EnviraGalleryError({model:t});return i.render().el},addToSelection:function(e,t){this.trigger("loading"),this.collection.each(function(e){e.get("id")==t&&this.getSelection().add(e)},this),e.addClass("selected details"),this.trigger("loaded")},removeFromSelection:function(e,t){this.trigger("loading"),this.getSelection().each(function(e){this.getSelection().remove([{cid:e.cid}])},this),e.removeClass("selected details"),this.trigger("loaded")},getSelection:function(){return this.controller.state().props},clearSelection:function(){this.selection=this.getSelection(),this.selection.each(function(e){this.$el.find('div[data-id="'+e.get("id")+'"]').parent().removeClass("selected details")},this),this.selection.reset()}}),wp.media.controller.EnviraGalleryController=wp.media.controller.State.extend({insert_action:"",initialize:function(e){this.props=new Backbone.Collection,this.insert_action=e.insert_action},insert:function(){var e=this.frame.content.get(),t=[];this.button=this.frame.toolbar.get().get("envira_gallery_insert"),this.button.model.set("text",wp.media.view.l10n.inserting),this.button.model.set("disabled",!0),this.trigger("loading"),e.getSelection().each(function(e){t.push(e.get("id"))},this),wp.media.ajax(this.insert_action,{context:this,data:{nonce:envira_gallery_media_insert.nonce,post_id:envira_gallery_media_insert.post_id,images:t},success:function(t){jQuery("ul#envira-gallery-output").html(t),this.trigger("loaded"),this.button.model.set("text",wp.media.view.l10n.insertIntoPost),this.button.model.set("disabled",!1),e.clearSelection(),this.frame.close()},error:function(t){this.button.model.set("text",wp.media.view.l10n.insertIntoPost),this.button.model.set("disabled",!1),e.trigger("loaded",t)}})}});var EnviraGalleryPostFrame=wp.media.view.MediaFrame.Post;wp.media.view.MediaFrame.Post=EnviraGalleryPostFrame.extend({initialize:function(){EnviraGalleryPostFrame.prototype.initialize.apply(this,arguments),_.each(envira_gallery_media_insert.addons,function(e,t){this.states.add([new wp.media.controller.EnviraGalleryController({id:t,content:t+"-content",toolbar:t+"-toolbar",menu:"default",title:wp.media.view.l10n[t],priority:200,type:"link",insert_action:e+"_insert_images"})]),this.on("content:render:"+t+"-content",_.bind(this.renderContent,this,t,e)),this.on("toolbar:create:"+t+"-toolbar",this.renderToolbar,this)},this)},renderContent:function(e,t){this.content.set(new wp.media.view.EnviraGalleryView({controller:this,model:this.state().props,addon:e,sidebar_template:e+"-side-bar",get_action:t+"_get_files_folders",search_action:t+"_search_files_folders",insert_action:t+"_insert_images",path:"/"}))},renderToolbar:function(e){e.view=new wp.media.view.Toolbar.EnviraGalleryToolbar({controller:this})}});